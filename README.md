# Сервис управления кошельками на Go

## Описание

Сервис предоставляет клиенту REST API с двумя конечными точками по получению баланса кошелька и выполнению с ним одной из двух операций (списание или пополнение).

## Эндпоинты

### POST /api/v1/wallets

Обновить баланс кошелька по указанному `walletID`. `operationType` регулирует операцию: списание или пополнение. Пополнение несуществующего кошелька приводит к его созданию с указанным балансом (`amount`). Списание с несуществующего кошелька или списание, переводящее баланс кошелька ниже 0, приводит к ошибке `400 Bad Request`. `amount` должен быть больше 0.

**Тело запроса**

```json
{
  "walletID": uint,
  "operationType": "WITHDRAW" | "DEPOSIT",
  "amount": uint
}
```

### GET /api/v1/wallets/{id}

Получить баланс кошелька с указанным `id`. Запрос несуществующего кошелька приводит к ошибке `404 Not Found`.

### Ответы

Обе конечные точки отвечают в нижеуказанном формате с кодом ответа `200 OK`.

```json
{
  "success": false | true,
  "message": string,
  "data": {
    "id": uint,
    "amount": uint
  }
}
```

`success` указывает на успешность выполнения операции. `message` равен пустой строке, если `success` = `true`, и содержит сообщение об ошибке, если `success` = `false`.
`data` содержит идентификатор и баланс кошелька, который был получен или изменён.

## Настройка

Приложение настраивается с помощью переменных окружения. Пример с указанием всех необходимых переменных содержится в файле `config.env.example`. Для настройки нужно создать файл с расширением `.env` и заполнить его. По умолчанию используется путь до файла `config.env`, расположенного в корне проекта. Его можно поменять, передав при запуске параметр `--config`.

## Развёртывание

Для развёртывания используется базовый образ Docker `golang`. С помощью файла Docker Compose также описывается запуск PostgreSQL в соседнем контейнере. С помощью утилиты `Air` происходит запуск в контейнере множества инстансов сервера с возможностями Live Reload, благодаря монтированию volume.

Запуск одной командой: `docker compose up`

## Обеспечение отказоустойчивости

К приложению предъявляются требования по обеспечению отказоустойчивости при высокой нагрузке (до 1000 RPS). Был предпринят ряд решений, которые позволят в большей мере удовлетворить данное требование.

### Меры

- Организация изолированных атомарных SQL-запросов, выполняющихся в рамках отдельных транзакций, для двух ключевых сценариев использования (чтение/изменение одного и того же кошелька);
- Использование Air для запуска множества инстансов сервера;
- Использование настройки `Prefork` из Fiber для запуска множества инстансов сервера;
- Корректная конфигурация пула соединений GORM.

Использовались "сырые" запросы через `gorm.DB.Exec`, поскольку встроенные методы библиотеки не позволяют реализовать ту же логику атомарно.

### Тестирование

Данная сборка тестировалась с помощью утилиты `hey` со следующей командой:

```bash
hey -z 15s -q 1000 -m POST -H "Content-Type: application/json" -d '{"walletID": 1,"operationType":"DEPOSIT","amount":42}' http://localhost:8192/api/v1/wallets
```

- `z` - длительность тестирования
- `q` - количество запросов в секунду

Проведённые тесты показали положительные результаты: около 10К запросов за 10-15 секунд были обработаны с кодом 200 без ошибок.
